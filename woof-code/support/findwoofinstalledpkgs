#!/bin/bash
#(c) Copyright Barry Kauler 2009, puppylinux.com
# - this script finds all builtin packages in Puppy Linux.
# - creates: woof-installed-packages and devx-only-installed-packages
# - this script is not reliable

export LANG=C

. ./_00func
. ./DISTRO_SPECS     # has DISTRO_BINARY_COMPAT, DISTRO_COMPAT_VERSION
source_pkgs_specs    # ./DISTRO_PKGS_SPECS-

echo "Creating file woof-installed-packages..."

#remove comments from PKGS_SPECS_TABLE... make sure '|' on end... get rid of old |+udev,+whatever on end...
PKGS_SPECS_TABLE="`echo "$PKGS_SPECS_TABLE" | grep -v '^#' | grep -v '^$' | tr '\t' ' ' | tr -s ' ' | tr '+' '&' | sed -e 's%|&.*%%' | tr '&' '+' | sed -e 's% #.*%%' -e 's% $%%' -e 's%$%|%' -e 's%||$%|%'`"

run_findpkgs #find all packages that will be used in the Puppy build...

#need to find exactly what has gone into the build and the devx...
echo -n "" > /tmp/woof-installed-packages-tmp
echo -n "" > /tmp/devx-only-installed-packages-tmp #121028
(
cat status/findpkgs_FINAL_PKGS-${DISTRO_BINARY_COMPAT}-${DISTRO_COMPAT_VERSION} |
while read ONELINE
do
	#ex: :a52dec:|compat|Packages-puppy-wary5-official|a52dec-0.7.4-w5|a52dec|0.7.4-w5||BuildingBlock|68K||a52dec-0.7.4-w5.pet||A free ATSC A52 stream decoder|puppy|wary5||
	IFS="|" read -r F1 F2 F3 F4 F5 ETC <<< "$ONELINE"
	ADBENTRY="${F4}|${F5}|${ETC}" #"`echo -n "$ONELINE" | cut -f 4-19 -d '|'`"
	GENERICNAMES="$F1"
	NAMEONLY="$F5"
	case $NAMEONLY in
		*_DEV) PTN1='dev'     ; PNT2='dev>exe'  ;;
		*_DOC) PTN1='doc>exe' ; PNT2='doc>dev' ;;
		*_NLS) PTN1='nls>exe' ; PNT2='nls>dev' ;;
		*)     PTN1=''        ; PNT2='' ;; #allow all thru...
	esac
	for AGENERICNAME in ${GENERICNAMES//:/ }
	do
		PKGZ="`echo "$PKGS_SPECS_TABLE" | grep "^yes|${AGENERICNAME}|"`"
		if [ -z "$PKGZ" ] ; then
			continue
		fi
		#-
		# yes|normalize|normalize-audio|exe,dev,doc,nls
		IFS="|" read -r Z1 Z2 Z3 SPLITUPS ETC <<< "$PKGZ"
		if ! [ "$SPLITUPS" ] ; then
			# yes|normalize|normalize-audio|
			echo "$ADBENTRY" # >> /tmp/woof-installed-packages-tmp
			break
		fi
		# exe,dev,doc,nls
		for i in ${SPLITUPS//,/ }
		do
			if [ "$i" = "exe>dev" ] ; then
				echo "$ADBENTRY" >> /tmp/devx-only-installed-packages-tmp
				break
			fi
			if [ "$i" = "$PTN1" -o "$i" = "$PTN2" -o "$PTN1" = "" ] ; then
				echo "$ADBENTRY" # >> /tmp/woof-installed-packages-tmp
				break
			fi
		done
	done
done
) >> /tmp/woof-installed-packages-tmp
sync

# added for rootfs-packages
if [ -f /tmp/rootfs-packages.specs ] ; then
	cat /tmp/rootfs-packages.specs >> /tmp/woof-installed-packages-tmp
fi

sort -u --key=1 --field-separator="|" /tmp/woof-installed-packages-tmp > woof-installed-packages
if [ -s /tmp/devx-only-installed-packages-tmp ];then
	sort -u --key=1 --field-separator="|" /tmp/devx-only-installed-packages-tmp > devx-only-installed-packages
fi

###END###
